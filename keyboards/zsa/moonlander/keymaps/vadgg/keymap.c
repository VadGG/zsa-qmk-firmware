/* Copyright 2020 ZSA Technology Labs, Inc <@zsa>
 * Copyright 2020 Jack Humbert <jack.humb@gmail.com>
 * Copyright 2020 Christopher Courtney, aka Drashna Jael're  (@drashna) <drashna@live.com>
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

#include <stdint.h>

#include QMK_KEYBOARD_H
#include "version.h"
#include "keymap.h"
#include "helpers.h"

static inline uint8_t min(uint8_t a, float b) {
    return (b < a) ? (uint8_t)b : a;
}

// ------------- COMBO ---------------
// const uint16_t PROGMEM custom_esc[] = {KC_D, KC_S, COMBO_END};
// const uint16_t PROGMEM custom_tab[] = {KC_D, KC_S, COMBO_END};

// const uint16_t PROGMEM custom_enter[] = {KC_J, KC_K, COMBO_END};
// const uint16_t PROGMEM custom_colon[] = {KC_H, KC_J, COMBO_END};

// const uint16_t PROGMEM custom_backspace[] = {KC_O, KC_P, COMBO_END};
// const uint16_t PROGMEM custom_backspace_word[] = {KC_I, KC_O, KC_P, COMBO_END};
// const uint16_t PROGMEM custom_delete_word[] = {KC_W, KC_E, KC_R, COMBO_END};

const uint16_t PROGMEM to_num[] = {KC_SPACE, KC_ENT, COMBO_END};

const uint16_t PROGMEM qmk_boot[] = {KC_R, KC_TAB, COMBO_END};
const uint16_t PROGMEM arr_panic[] = {KC_UP, KC_DOWN, COMBO_END};

combo_t                key_combos[] = {
    // COMBO(custom_esc, KC_ESC),
    // COMBO(custom_tab, KC_TAB),
    // COMBO(custom_enter, KC_ENT),
    // COMBO(custom_colon, KC_COLON),
    // COMBO(custom_backspace, KC_BACKSPACE),
    // COMBO(custom_backspace_word, KC_BACKSPACE_WORD),
    // COMBO(custom_delete_word, KC_DELETE),
    COMBO(to_num, TO_NUM_LAYER),
    COMBO(qmk_boot, QK_BOOT),
    COMBO(arr_panic, TO(BASE)),
};



// ------------- END COMBO ---------------
#include "tap_dance.h"


// -----------------------------------
// -----------------------------------
#include "process_record_user.h"
// -----------------------------------

const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {
    [BASE] = LAYOUT(
     //|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|
        KC_GRAVE,                  KC_1,                      KC_2,                      KC_3,                      KC_4,                      KC_5,                       KC_LESS_THAN,             KC_MORE_THAN,              KC_6,                      KC_7,                      KC_8,                       KC_9,                     KC_0,                       KC_BACKSPACE,
     //|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|
        KC_TAB,                    KC_Q,                      KC_W,                      KC_E,                      KC_R,                      KC_T,                       KC_MINUS,                 KC_EQUAL,                  KC_Y,                      KC_U,                      KC_I,                       KC_O,                     KC_P,                       KC_MINUS,
     //|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|
        KC_ESCAPE,                 KC_A,                      KC_S,                      KC_D,                      KC_F,                      KC_G,                       TD(TD_LEFT_BRACKET),      KC_RIGHT_BRACKET,          KC_H,                      KC_J,                      KC_K,                       KC_L,                     KC_SEMICOLON,               KC_QUOTE,
     //|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|
        KC_LSFT,                   KC_Z,                      KC_X,                      KC_C,                      KC_V,                      KC_B,                                                                            KC_N,                      KC_M,                      KC_COMM,                    KC_DOT,                   KC_SLASH,                   KC_BACKSLASH,
     //|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|
        KC_LEFT_CTRL,              KC_LEFT_GUI,               KC_LEFT_ALT,               KC_DOWN,                   KC_UP,                                                 SGUI(KC_4),               KC_PRINT_SCREEN,                                      KC_LEFT,                   KC_RIGHT,                   KC_LEFT_ALT,              KC_LEFT_GUI,                KC_LEFT_CTRL,
     //|-----------------------------------------------------------------------------------------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|-----------------------------------------------------------------------------------------------------------|
                                                                                                                    KC_SPC,                    MO(_LMOD),                 KC_NO,                     KC_NO,                     MO(_RMOD),                   KC_ENT
     //|-----------------------------------------------------------------------------------------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|-----------------------------------------------------------------------------------------------------------|
    ),

    [_LMOD] = LAYOUT(
     //|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|
        KC_F12,                    KC_F1,                     KC_F2,                     KC_F3,                     KC_F4,                     KC_F5,                     _______,                   _______,                   KC_F6,                     KC_F7,                     KC_F8,                     KC_F9,                     KC_F10,                    KC_BACKSPACE,
     //|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|
        _______,                   KC_ESCAPE,                 _______,                   _______,                   _______,                   _______,                   _______,                   _______,                   KC_MINUS,                  LSFT(KC_TAB),              KC_TAB,                    KC_PLUS,                   KC_F11,                    KC_DELETE,
     //|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|
        KC_HYPR,                   KC_MEH,                    KC_LSFT,                   KC_LEFT_ALT,               KC_LEFT_CTRL,              KC_LEFT_GUI,               _______,                   _______,                   KC_LEFT,                   KC_DOWN,                   KC_UP,                     KC_RIGHT,                  KC_SEMICOLON,              KC_ESCAPE,
     //|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|
        _______,                   _______,                   _______,                   _______,                   _______,                   _______,                                                                         KC_N,                      KC_M,                   S(KC_COMM),                S(KC_DOT),                 KC_SLASH,                  _______,        
     //|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|
        _______,                   _______,                   _______,                   KC_KB_VOLUME_DOWN,         KC_KB_VOLUME_UP,                                      _______,                   _______,                                              _______,                   _______,                   _______,                   _______,                   _______,
     //|-----------------------------------------------------------------------------------------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|-----------------------------------------------------------------------------------------------------------|
                                                                                                                    _______,                   KC_TRANSPARENT,            _______,                   _______,                   _______,            _______
     //|-----------------------------------------------------------------------------------------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|-----------------------------------------------------------------------------------------------------------|
    ),

    [_RMOD] = LAYOUT(
     //|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|
        KC_F12,                    KC_F1,                     KC_F2,                     KC_F3,                     KC_F4,                     KC_F5,                     KC_NO,                     KC_NO,                     KC_F6,                     KC_F7,                     KC_F8,                     KC_F9,                     KC_F10,                    KC_F11,
     //|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|
        KC_DELETE,                 _______,                   _______,                   _______,                   _______,                   _______,                   _______,                   _______,                   _______,                   _______,                   _______,                    _______,                   _______,                   _______,
     //|-----------------------------------------------------------------------------------------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|-----------------------------------------------------------------------------------------------------------|
        _______,                   _______,                   _______,                   _______,                   _______,                   _______,                   _______,                   _______,                   KC_LEFT_GUI,               KC_LEFT_CTRL,              KC_LEFT_ALT,                KC_LSFT,                    KC_MEH,                   KC_HYPR,
     //|-----------------------------------------------------------------------------------------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|-----------------------------------------------------------------------------------------------------------|
        _______,                   _______,                   _______,                   _______,                   _______,                   _______,                                                                         _______,                   _______,                   _______,                    _______,                   _______,                   _______,
     //|-----------------------------------------------------------------------------------------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|-----------------------------------------------------------------------------------------------------------|
        _______,                   _______,                   _______,                   _______,                   _______,                                              _______,                   _______,                                              KC_KB_VOLUME_DOWN,         KC_KB_VOLUME_UP,            _______,                   _______,                   _______,
     //|-----------------------------------------------------------------------------------------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|-----------------------------------------------------------------------------------------------------------|
                                                                                                                    KC_SPC,                    _______,                   KC_NO,                     KC_NO,                     KC_TRANSPARENT,            KC_LSFT
     //|-----------------------------------------------------------------------------------------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|-----------------------------------------------------------------------------------------------------------|
    ),

    [_NUM] = LAYOUT(
     //|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|
        KC_NO,                     KC_NO,                     KC_NO,                     KC_NO,                     KC_NO,                     KC_NO,                     KC_NO,                     KC_NO,                     KC_NO,                     KC_NO,                     KC_NO,                     KC_NO,                     KC_NO,                    KC_NO,
     //|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|
        KC_NO,                     KC_NO,                     KC_NO,                     KC_K,                      KC_PERCENT,                KC_J,                      KC_NO,                     KC_NO,                     KC_NO,                     KC_NO,                     KC_DOT,                    KC_COMM,                   KC_BACKSPACE,              KC_NO,
     //|-----------------------------------------------------------------------------------------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|-----------------------------------------------------------------------------------------------------------|
        KC_NO,                     KC_6,                      KC_4,                      KC_0,                      KC_2,                      KC_NO,                     KC_NO,                     KC_NO,                     KC_NO,                     KC_3,                      KC_1,                      KC_5,                      KC_7,                      KC_NO,
     //|-----------------------------------------------------------------------------------------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|-----------------------------------------------------------------------------------------------------------|
        KC_NO,                     KC_KP_ASTERISK,            KC_NO,                     LSFT(KC_G),                KC_8,                      KC_NO,                                                                           KC_EQUAL,                  KC_9,                      KC_LEFT_BRACKET,           KC_LEFT_PAREN,             KC_RIGHT_PAREN,             KC_NO,
     //|-----------------------------------------------------------------------------------------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|-----------------------------------------------------------------------------------------------------------|
        KC_NO,                     KC_NO,                     KC_NO,                     KC_NO,                     KC_NO,                                                KC_NO,                     KC_NO,                                                KC_NO,                     KC_NO,                     KC_NO,                     KC_NO,                     KC_NO,
     //|-----------------------------------------------------------------------------------------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|-----------------------------------------------------------------------------------------------------------|
                                                                                                                    KC_SPC,                    TO_BASE,                   KC_NO,                     KC_NO,                     TO_BASE,                   TO_BASE
     //|-----------------------------------------------------------------------------------------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|-----------------------------------------------------------------------------------------------------------|
    ),

    [NUM] = LAYOUT(
     //|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|
        _______,                   LSFT(KC_F1),               LSFT(KC_F2),               LSFT(KC_F3),               LSFT(KC_F4),               LSFT(KC_F5),               _______,                   _______,                   LSFT(KC_F6),               LSFT(KC_F7),               LSFT(KC_F8),               LSFT(KC_F9),               LSFT(KC_F10),              _______,
     //|-----------------------------------------------------------------------------------------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|-----------------------------------------------------------------------------------------------------------|
        _______,                   KC_GRAVE,                  KC_QUOTE,                  LSFT(KC_QUOTE),            KC_LEFT_PAREN,             KC_RIGHT_PAREN,            _______,                   _______,                   TD(TD_BACKSPACE),          KC_7,                      KC_8,                      KC_9,                      KC_DOT,                    _______,
     //|-----------------------------------------------------------------------------------------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|-----------------------------------------------------------------------------------------------------------|
        KC_TRANSPARENT,            KC_COMM,                   KC_MINUS,                  KC_DOLLAR,                 KC_LEFT_CURLY_BRACE,       KC_RIGHT_CURLY_BRACE,      _______,                   _______,                   KC_BACKSPACE,              KC_4,                      KC_5,                      KC_6,                      KC_COMM,                   _______,
     //|-----------------------------------------------------------------------------------------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|-----------------------------------------------------------------------------------------------------------|
        _______,                   LSFT(KC_GRAVE),            KC_SLASH,                  KC_DOT,                    KC_RIGHT_BRACKET,          KC_LEFT_BRACKET,                                                                 KC_0,                      KC_1,                      KC_2,                      KC_3,                      KC_SLASH,                  _______,        
     //|-----------------------------------------------------------------------------------------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|-----------------------------------------------------------------------------------------------------------|
        _______,                   _______,                   _______,                  _______,                    _______,                                              _______,                   _______,                                              _______,                   _______,                   _______,                   _______,                   _______,
     //|-----------------------------------------------------------------------------------------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|-----------------------------------------------------------------------------------------------------------|
                                                                                                                    KC_SPC,                    _______,                   _______,                   _______,                   _______,                   KC_LSFT
     //|-----------------------------------------------------------------------------------------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|-----------------------------------------------------------------------------------------------------------|
    ),
    [_CUSTOM_MOD] = LAYOUT(
     //|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|
        TO(BASE),                   KC_F1,                     KC_F2,                     KC_F3,                     KC_F4,                     KC_F5,                     KC_NO,                     KC_NO,                     KC_F6,                     KC_F7,                     KC_F8,                     KC_F9,                     KC_F10,                    KC_F11,
     //|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|
        _______,                   _______,                   _______,                   _______,                   _______,                   _______,                   _______,                   _______,                   _______,                   _______,                   _______,                    _______,                   _______,                   _______,
     //|-----------------------------------------------------------------------------------------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|-----------------------------------------------------------------------------------------------------------|
        KC_TRANSPARENT,            KC_MEH,                   KC_LSFT,                   KC_LEFT_ALT,               KC_LEFT_CTRL,              KC_LEFT_GUI,               KC_LEFT_BRACKET,           KC_RIGHT_BRACKET,          KC_H,                      KC_J,                      KC_K,                      KC_L,                      KC_SEMICOLON,              KC_LEFT_GUI,
     //|-----------------------------------------------------------------------------------------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|-----------------------------------------------------------------------------------------------------------|
        KC_LSFT,                   _______,                   _______,                   _______,                   _______,                   _______,                                                                         _______,                   _______,                   _______,                   _______,                    _______,                  _______,
     //|-----------------------------------------------------------------------------------------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|-----------------------------------------------------------------------------------------------------------|
        KC_LEFT_CTRL,              _______,                   _______,                   _______,                   _______,                                              _______,                   _______,                                              _______,                   _______,                  _______,                     _______,                  _______,
     //|-----------------------------------------------------------------------------------------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|-----------------------------------------------------------------------------------------------------------|
                                                                                                                               KC_SPC,         KC_KB_VOLUME_DOWN,         KC_NO,                     KC_NO,                      KC_KB_VOLUME_UP,          KC_LSFT
     //|-----------------------------------------------------------------------------------------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|--------------------------|-----------------------------------------------------------------------------------------------------------|
    ),
};

extern rgb_config_t rgb_matrix_config;

void keyboard_post_init_user(void) {
    rgb_matrix_enable();
}

// Helper struct for HSB colors
typedef struct {
    uint8_t h; // 0-255 (0-360 degrees)
    uint8_t s; // 0-255 (0-100%)
    uint8_t b; // 0-255 (0-100%)
} hsb_color;

// Helper structs for color types
typedef struct {
    uint8_t r;
    uint8_t g;
    uint8_t b;
} rgb_color;

// Helper macro to define HSB colors - h: 0-360, s: 0-100, b: 0-100
#define HSB(h, s, b) { \
    (uint8_t)((h) * 255 / 360), \
    (uint8_t)((s) * 255 / 100), \
    (uint8_t)((b) * 255 / 100) \
}

// Color definitions using HSB values
#define COLOR_NORMAL    HSB(220, 98, 33)    // Dark blue

#define COLOR_OFF HSB(0, 0, 0)

#define COLOR_TRANSPARENT_BASE HSB(0, 0, 0)
#define COLOR_TRANSPARENT_OTHER HSB(90, 18, 10)

#define COLOR_MODIFIER  HSB(40, 93, 99)     // Orange
#define COLOR_ARROW    HSB(353, 63, 69)     // Redwood
#define COLOR_SYMBOL   HSB(112, 63, 79)     // Dark pastel green
#define COLOR_BRACKET   HSB(150, 63, 79)     // 
#define COLOR_OPERATOR   HSB(100, 63, 79)     // 
#define COLOR_ESC      HSB(263, 53, 86)     // Purple
#define COLOR_SPACE    HSB(47, 73, 95)      // Yellow

#define COLOR_DELETE   HSB(355, 87, 94)     // Bright red
#define COLOR_BACKSPACE   HSB(305, 87, 60)     // Bright red

#define COLOR_ENTER    HSB(64, 36, 94)     // Bright green

#define COLOR_NUMBER   HSB(252, 26, 76)     // Grayish purple
#define COLOR_FUNCTION HSB(311, 87, 71)     // Bright purple
#define COLOR_ALPHA    HSB(210, 27, 15)     // Black olive

#define COLOR_LAYER    HSB(255, 81, 100)     // Bright purple
#define COLOR_HOMEROW  HSB(59, 72, 100)      // Bright yellow

#define COLOR_SHIFT    HSB(200, 88, 100)     // Blue
#define COLOR_ALT      HSB(120, 88, 100)      // Orangish yellow
#define COLOR_CTRL     HSB(5, 88, 100)      // Orange
#define COLOR_GUI      HSB(55, 88, 100)     // Light blue

#define COLOR_UNKNOWN      HSB(0, 0, 100)     // White


// Helper function for HSB to RGB conversion
static inline rgb_color hsb_to_rgb(hsb_color hsb) {
    rgb_color rgb = {0, 0, 0};
    
    uint8_t region, remainder, p, q, t;
    
    if (hsb.s == 0) {
        rgb.r = rgb.g = rgb.b = hsb.b;
        return rgb;
    }
    
    region = hsb.h / 43;
    remainder = (hsb.h - (region * 43)) * 6; 
    
    p = (hsb.b * (255 - hsb.s)) >> 8;
    q = (hsb.b * (255 - ((hsb.s * remainder) >> 8))) >> 8;
    t = (hsb.b * (255 - ((hsb.s * (255 - remainder)) >> 8))) >> 8;
    
    switch (region) {
        case 0:
            rgb.r = hsb.b; rgb.g = t; rgb.b = p;
            break;
        case 1:
            rgb.r = q; rgb.g = hsb.b; rgb.b = p;
            break;
        case 2:
            rgb.r = p; rgb.g = hsb.b; rgb.b = t;
            break;
        case 3:
            rgb.r = p; rgb.g = q; rgb.b = hsb.b;
            break;
        case 4:
            rgb.r = t; rgb.g = p; rgb.b = hsb.b;
            break;
        default:
            rgb.r = hsb.b; rgb.g = p; rgb.b = q;
            break;
    }
    
    return rgb;
}

hsb_color get_mod_color_based_on_mod_status(bool is_mod_state, bool is_toggled_on, hsb_color color) {
    if (is_on_mod_selector_layer()) {
        return is_toggled_on ?(hsb_color){color.h, color.s, 100} :(hsb_color){color.h, color.s, 5};
    }

    if (!is_mod_state) {
        return (hsb_color){color.h, color.s, 30};
    }

    return is_toggled_on ?(hsb_color){color.h, color.s, 100} :(hsb_color){color.h, color.s, 5};
}


hsb_color reduce_brightness(hsb_color color, float percent_brightness) {
    return (hsb_color){color.h, color.s, color.b * percent_brightness};
}
// Helper function to blend HSB colors
hsb_color blend_hsb_colors(hsb_color base_color, hsb_color mod_color) {
    // Average the hues
    uint16_t avg_hue = (base_color.h * 0.1 + mod_color.h * 0.9);
    
    // Keep base color's saturation, but increase brightness
    uint8_t blended_saturation = base_color.s;
    uint8_t blended_brightness = min(255, base_color.b * 2); // 50% brighter
    
    return (hsb_color){
        .h = (uint8_t)avg_hue,
        .s = blended_saturation,
        .b = blended_brightness
    };
}

// Function to get the base color for a key without mod blending
hsb_color get_base_key_color(uint16_t keycode, uint8_t layer) {
    switch (keycode) {
        case KC_A ... KC_Z:
            return (hsb_color)COLOR_ALPHA;
        case KC_1 ... KC_0:
            return (hsb_color)COLOR_NUMBER;
        case KC_F1 ... KC_F12:
            return (hsb_color)COLOR_FUNCTION;
        case KC_LEFT:
        case KC_RIGHT:
        case KC_UP:
        case KC_DOWN:
            return (hsb_color)COLOR_ARROW;
        case KC_TAB:
        case KC_SPC:
            return (hsb_color)COLOR_SPACE;
        case KC_ESC:
            return (hsb_color)COLOR_ESC;
        case KC_ENT:
            return (hsb_color)COLOR_ENTER;
        case KC_BSPC:
            return (hsb_color)COLOR_BACKSPACE;
        case KC_DEL:
            return (hsb_color)COLOR_DELETE;
        case KC_GRAVE:
        case KC_LT:
        case KC_GT:
            return (hsb_color)COLOR_SYMBOL;
        case KC_BSLS:
        case KC_SCLN:
        case KC_QUOT:
        case KC_COMM:
        case KC_DOT:
        case KC_SLSH:
            return (hsb_color)COLOR_SYMBOL;
        case KC_LEFT_PAREN: 
        case KC_RIGHT_PAREN: 
        case KC_LEFT_CURLY_BRACE: 
        case KC_RIGHT_CURLY_BRACE: 
        case KC_LEFT_BRACKET: 
        case KC_RIGHT_BRACKET: 
            return (hsb_color)COLOR_BRACKET;
        case KC_MINS:
        case KC_PLUS:
        case KC_EQUAL:
        case KC_KP_ASTERISK:
        case KC_PERCENT:
            return (hsb_color)COLOR_OPERATOR;
        default:
            return (hsb_color)COLOR_UNKNOWN;
    }
}

// Function to get the final key color, potentially blending with modifier
hsb_color get_key_color(uint16_t keycode, uint8_t row, uint8_t col, uint8_t layer) {
    // Check for transparent keys
    if (keycode == KC_NO) {
        return (hsb_color)COLOR_OFF;
    }

    if (keycode == KC_TRANSPARENT) {
        if (layer == BASE) {
            return (hsb_color)COLOR_TRANSPARENT_BASE;
        } else {
            return (hsb_color)COLOR_TRANSPARENT_OTHER;
        }
    }

    // Modifier key handling remains the same
    if (is_modifier_key(keycode)) {
        switch (keycode) {
            case KC_LEFT_ALT:
            case KC_RIGHT_ALT:
                return get_mod_color_based_on_mod_status(is_custom_mod_on(), is_alt_mod_on(), (hsb_color)COLOR_ALT);
            case KC_LSFT:
            case KC_RSFT:
                return get_mod_color_based_on_mod_status(is_custom_mod_on(), is_shift_mod_on(), (hsb_color)COLOR_SHIFT);
            case KC_LEFT_GUI:
            case KC_RIGHT_GUI:
                return get_mod_color_based_on_mod_status(is_custom_mod_on(), is_gui_mod_on(), (hsb_color)COLOR_GUI);
            case KC_LEFT_CTRL:
            case KC_RIGHT_CTRL:
                return get_mod_color_based_on_mod_status(is_custom_mod_on(), is_ctrl_mod_on(), (hsb_color)COLOR_CTRL);
            default:
                if (!is_on_mod_selector_layer()) {
                    return get_mod_color_based_on_mod_status(is_custom_mod_set(), false, (hsb_color)COLOR_MODIFIER);
                }
        }
    }     

    if (is_on_mod_selector_layer()) {
        return (hsb_color)COLOR_OFF;
    }

    if (layer == BASE) {
        switch(keycode){
            case KC_J:
            case KC_K:
                return (hsb_color)COLOR_ENTER;
            case KC_S:
            case KC_D:
                return (hsb_color)COLOR_ESC;
            case KC_O:
            case KC_P:
                return (hsb_color)COLOR_BACKSPACE;
            case KC_I:
                return reduce_brightness((hsb_color)COLOR_BACKSPACE, 0.2);
            case KC_W:
            case KC_E:
            case KC_R:
                return (hsb_color)COLOR_DELETE;
        }
    }


    // Proceed with existing color selection logic for non-blended cases
    if (IS_QK_LAYER_TAP(keycode) || IS_QK_TO(keycode) || IS_QK_MOMENTARY(keycode)) {
        return (hsb_color)COLOR_LAYER;
    }

    // Custom mod color blending logic
    if (is_custom_mod_on()) {
        hsb_color base_color = get_base_key_color(keycode, layer);
        hsb_color mod_color = (hsb_color){0};
        bool has_mod_color = false;

        // Check which modifier is on and set mod color accordingly
        if (is_alt_mod_on()) {
            mod_color = (hsb_color)COLOR_ALT;
            has_mod_color = true;
        } else if (is_shift_mod_on()) {
            mod_color = (hsb_color)COLOR_SHIFT;
            has_mod_color = true;
        } else if (is_ctrl_mod_on()) {
            mod_color = (hsb_color)COLOR_CTRL;
            has_mod_color = true;
        } else if (is_gui_mod_on()) {
            mod_color = (hsb_color)COLOR_GUI;
            has_mod_color = true;
        }

        // If a modifier is active, blend the colors
        if (has_mod_color) {
            return blend_hsb_colors(base_color, mod_color);
        }
    }

    // Get base key color for all other cases
    return get_base_key_color(keycode, layer);
}

bool rgb_matrix_indicators_user(void) {
    if (keyboard_config.disable_layer_led) { return false; }
    
    uint8_t current_layer = get_highest_layer(layer_state);
    
    for (uint8_t row = 0; row < MATRIX_ROWS; row++) {
        for (uint8_t col = 0; col < MATRIX_COLS; col++) {
            uint8_t index = g_led_config.matrix_co[row][col];
            if (index >= DRIVER_LED_TOTAL) continue;
            
            uint16_t keycode = keymap_key_to_keycode(current_layer, (keypos_t){.row = row, .col = col});
            hsb_color hsb = get_key_color(keycode, row, col, current_layer);
            rgb_color rgb = hsb_to_rgb(hsb);
            
            rgb_matrix_set_color(index, rgb.r, rgb.g, rgb.b);
        }
    }
    
    return false;
}










// Determine the current tap dance state
td_state_t cur_dance(tap_dance_state_t *state) {
    if (state->count == 1) {
        if (!state->pressed) return TD_SINGLE_TAP;
        else return TD_SINGLE_HOLD;
    } else if (state->count == 2) return TD_DOUBLE_TAP;
    else return TD_UNKNOWN;
}

// Initialize tap structure associated with example tap dance key
static td_tap_t ql_tap_state = {
    .is_press_action = true,
    .state = TD_NONE
};

// Functions that control what our tap dance key does
void ql_finished(tap_dance_state_t *state, void *user_data) {
    ql_tap_state.state = cur_dance(state);
    switch (ql_tap_state.state) {
        case TD_SINGLE_TAP:
            // tap_code16(MY_CUSTOM_MOD_TOGGLE);
            if (!is_custom_mod_set()) {
                ctrl_key_toggle = false;
            } else {
                ctrl_key_toggle = !ctrl_key_toggle;
            }
            break;
        case TD_SINGLE_HOLD:
            // layer_on(_CUSTOM_MOD);
            ctrl_key_held = false;
            clear_mon_selectors();

            if (layer_state_is(_CUSTOM_MOD)) {
                // If already set, then switch it off
                layer_off(_CUSTOM_MOD);
            } else {
                // If not already set, then switch the layer on
                layer_on(_CUSTOM_MOD);
            }
            break;
        case TD_DOUBLE_TAP:
            break;
        default:
            break;
    }
}

void ql_reset(tap_dance_state_t *state, void *user_data) {
    // If the key was held down and now is released then switch off the layer
    if (ql_tap_state.state == TD_SINGLE_HOLD) {
        layer_off(_CUSTOM_MOD);
        ctrl_key_toggle = is_custom_mod_set();
    } else if (ql_tap_state.state == TD_DOUBLE_TAP) {
        // layer_off(_CUSTOM_MOD);
    }
    ql_tap_state.state = TD_NONE;
}

static bool left_bracket_held = false; // Tracks if the key is held

void td_left_bracket_finished(tap_dance_state_t *state, void *user_data) {
    if (state->count == 1) {
         if (!state->pressed) {
            // Single tap sends [
            tap_code16(KC_LEFT_BRACKET);
        } else {
            // Single hold starts sending [
            left_bracket_held = true;
            register_code(KC_LEFT_BRACKET);
        }
    } else if (state->count == 2) {
        process_record_user(OPEN_BRACKET, &(keyrecord_t){.event = {.pressed = true}});
        process_record_user(OPEN_BRACKET, &(keyrecord_t){.event = {.pressed = false}});
    }
}

void td_left_bracket_reset(tap_dance_state_t *state, void *user_data) {
    if (left_bracket_held) {
        unregister_code(KC_LEFT_BRACKET);
        left_bracket_held = false;
    }
}
// Associate our tap dance key with its functionality
tap_dance_action_t tap_dance_actions[] = {
    [MY_CMOD] = ACTION_TAP_DANCE_FN_ADVANCED(NULL, ql_finished, ql_reset),
    [TD_BACKSPACE] = ACTION_TAP_DANCE_DOUBLE(KC_BACKSPACE, KC_BACKSPACE_WORD), 
    [TD_LEFT_BRACKET] = ACTION_TAP_DANCE_FN_ADVANCED(NULL, td_left_bracket_finished, td_left_bracket_reset),
};

// Set a long-ish tapping term for tap-dance keys
uint16_t get_tapping_term(uint16_t keycode, keyrecord_t *record) {
    switch (keycode) {
        case MY_CMOD:
            return 100;
        case QK_TAP_DANCE ... QK_TAP_DANCE_MAX:
            return 175;
        default:
            return TAPPING_TERM;
    }
}
